{
	auto_https off
}

:8080 {
	log {
		output stdout
		format console
	}
	
	encode zstd gzip
	
	# MinIO console (subdomain)
	@minioConsole host minio.fibeger.com
	reverse_proxy @minioConsole minio:9001 {
		header_up X-Real-IP {http.request.header.CF-Connecting-IP}
		header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
	}

	# MinIO S3 API under /minio on apex
	@minioAPI path /minio*
	handle @minioAPI {
		uri strip_prefix /minio
		reverse_proxy minio:9000 {
			header_up X-Real-IP {http.request.header.CF-Connecting-IP}
			header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
		}
	}

	# Default: Next.js app (everything else)
	reverse_proxy app:3000 {
		header_up X-Real-IP {http.request.header.CF-Connecting-IP}
		header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
	}
}
