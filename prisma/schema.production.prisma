// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    Int                   @id @default(autoincrement())
  username              String                @unique
  email                 String                @unique
  password              String
  nickname              String?
  bio                   String?
  avatar                String?
  banner                String?               // Profile banner/header image
  lastUsernameChange    DateTime?
  
  // New customization fields
  country               String?               // Country code (e.g., "US", "GB", "DE")
  city                  String?               // City or location
  pronouns              String?               // User's pronouns
  birthday              String?               // Birthday (MM-DD format for privacy)
  website               String?               // Personal website URL
  socialLinks           String?               // JSON object with social media links
  status                String?               // Custom status message (max 100 chars)
  themeColor            String?               // Custom accent color (hex code)
  interests             String?               // JSON array of interests/tags
  personalityBadge      String?               // Personality test result badge
  showPersonalityBadge  Boolean               @default(true)        // Whether to show personality badge on profile
  notificationSoundsEnabled Boolean           @default(true)        // Whether notification sounds are enabled
  browserNotificationsEnabled Boolean         @default(false)       // Whether browser notifications are enabled
  steamUsername         String?               // Steam username
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Relations
  sentFriendRequests    FriendRequest[]       @relation("sentFriendRequests")
  receivedFriendRequests FriendRequest[]      @relation("receivedFriendRequests")
  friends               Friend[]              @relation("userFriends")
  friendOf              Friend[]              @relation("friendOf")
  conversations         ConversationMember[]
  groupChats            GroupChatMember[]
  messages              Message[]
  usernameHistory       UsernameHistory[]
  notifications         Notification[]
  reactions             Reaction[]
  feedPosts             FeedPost[]
  feedLikes             FeedLike[]
}

model Friend {
  id        Int     @id @default(autoincrement())
  userId    Int
  friendId  Int
  createdAt DateTime @default(now())

  user      User @relation("userFriends", fields: [userId], references: [id], onDelete: Cascade)
  friend    User @relation("friendOf", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
}

model FriendRequest {
  id        Int      @id @default(autoincrement())
  senderId  Int
  receiverId Int
  status    String   @default("pending") // pending, accepted, rejected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sender    User @relation("sentFriendRequests", fields: [senderId], references: [id], onDelete: Cascade)
  receiver  User @relation("receivedFriendRequests", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
}

model Conversation {
  id        Int     @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   ConversationMember[]
  messages  Message[]
}

model ConversationMember {
  id             Int      @id @default(autoincrement())
  conversationId Int
  userId         Int
  joinedAt       DateTime @default(now())
  lastReadMessageId Int?  // Track the last message read by this user

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
}

model GroupChat {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  avatar      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     GroupChatMember[]
  messages    Message[]
}

model GroupChatMember {
  id         Int      @id @default(autoincrement())
  groupChatId Int
  userId     Int
  role       String   @default("member") // member, admin
  joinedAt   DateTime @default(now())
  lastReadMessageId Int?  // Track the last message read by this user

  groupChat  GroupChat @relation(fields: [groupChatId], references: [id], onDelete: Cascade)
  user       User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupChatId, userId])
}

model Message {
  id             Int      @id @default(autoincrement())
  content        String
  attachments    String?  // JSON array of attachment URLs
  senderId       Int
  conversationId Int?
  groupChatId    Int?
  replyToId      Int?     // ID of the message being replied to
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sender       User @relation(fields: [senderId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  groupChat    GroupChat? @relation(fields: [groupChatId], references: [id], onDelete: Cascade)
  replyTo      Message? @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies      Message[] @relation("MessageReplies")
  reactions    Reaction[]
}

model Reaction {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    Int
  emoji     String   // The emoji character
  createdAt DateTime @default(now())

  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model UsernameHistory {
  id          Int      @id @default(autoincrement())
  userId      Int
  oldUsername String
  newUsername String
  changedAt   DateTime @default(now())

  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String   // friend_request, message, group_invite, etc.
  title     String
  message   String
  link      String?  // Optional link to navigate to
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}

model FeedPost {
  id        Int      @id @default(autoincrement())
  userId    Int
  caption   String?
  mediaUrl  String   // URL to the uploaded media
  mediaType String   // image, video, gif
  isPublic  Boolean  @default(false) // true = public feed, false = friends only
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes     FeedLike[]

  @@index([userId])
  @@index([createdAt])
  @@index([isPublic])
}

model FeedLike {
  id        Int      @id @default(autoincrement())
  postId    Int
  userId    Int
  createdAt DateTime @default(now())

  post      FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
}

model FileBlob {
  id          Int      @id @default(autoincrement())
  hash        String   @unique  // SHA-256 hash of the file content
  url         String             // Blob storage URL
  contentType String             // MIME type
  size        Int                // File size in bytes
  uploadedBy  Int                // User who first uploaded this file
  uploadedAt  DateTime @default(now())
  
  @@index([hash])
}